## Группы

#### Представление Группы

| **Поле**                   | **Название поля в системе** | **Формат / возможные значения**  | **Описание**                                                                                                                        |
|:--------------------------:|:---------------------------:|:--------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------:|
| Идентификатор клиента      | Customer_ID                 | ---                              | ---                                                                                                                                 |
| Идентификатор группы       | Group_ID                    | ---                              | ---                                                                                                                                 |
| Индекс востребованности    | Group_Affinity_Index        | Арабская цифра, десятичная дробь | Коэффициент востребованности данной группы клиентом                                                                                 |
| Индекс оттока              | Group_Churn_Rate            | Арабская цифра, десятичная дробь | Индекс оттока клиента по конкретной группе                                                                                          |
| Индекс стабильности        | Group_Stability_Index       | Арабская цифра, десятичная дробь | Показатель, демонстрирующий стабильность потребления группы клиентом                                                                |
| Актуальная маржа по группе | Group_Margin                | Арабская цифра, десятичная дробь | Показатель актуальной маржи по группе для конкретного клиента                                                                       |
| Доля транзакций со скидкой | Group_Discount_Share        | Арабская цифра, десятичная дробь | Доля транзакций по покупке группы клиентом, в рамках которых были применена скидка (без учета списния бонусов программы лояльности) |
| Минимальный размер скидки  | Group_Minimum_Discount      | Арабская цифра, десятичная дробь | Минимальный размер скидки, зафиксированный для клиента по группе                                                                    |
| Средний размер скидки      | Group_Average_Discount      | Арабская цифра, десятичная дробь | Средний размер скидки по группе для клиента                                                                                         |

Определение востребованных групп SKU для каждого клиента

1. **Формирование списка SKU для клиента.** Для каждого клиента (для
   всех карт клиента) формируется список всех SKU, которые покупал
   клиент в течение анализируемого периода. Для этого используются
   данные, содержащиеся в поле `SKU_ID` таблицы [Чеки](../README.md#таблица-чеки). Для
   идентификации всех транзакций клиента используются данные,
   содержащиеся в полях `Transaction_ID` таблиц [Чеки](../README.md#таблица-чеки)
   и [Транзакции](../README.md#таблица-транзакции), `Customer_Card_ID`
   таблиц [Транзакции](../README.md#таблица-транзакции) и [Карты](../README.md#таблица-карты), `Customer_ID`
   таблицы [Персональные данные](../README.md#таблица-персональные-данные).

2. **Дедубликация списка SKU.** После формирования из списка SKU
   каждого клиента удаляются дубликаты таким образом, чтобы в
   результате для каждого клиента был сформирован перечень уникальных
   SKU, которые он приобретал в течение анализируемого периода.

3. **Определение списка востребованных групп для клиента.** Для каждого
   клиента по каждому уникальному SKU на основании данных из товарной
   матрицы указывается группа, к которой относится данный SKU. Для
   этого используются данные, содержащиеся в полях `SKU_ID` и
   `Group_ID` таблицы [Товарная матрица](../README.md#таблица-товарная-матрица).

4. **Дедубликация списка групп.** После формирования из списка групп,
   востребованных клиентом, удаляются дубликаты таким образом, чтобы в
   результате для каждого клиента был сформирован перечень уникальных
   групп, которые он приобретал в течение анализируемого периода.
   Итоговый результат сохраняется в поле `Group_ID` таблиц [Периоды](../README.md#представление-периоды) и Группы. В
   таблицах должны содержаться
   уникальные значения, сформированные из пары Идентификатор клиента
   (`Customer_ID`) – Идентификатор группы (`Group_ID`).

5. **Подсчет финансовых показателей по группе.** Для каждого клиента по
   каждой группе осуществляется подсчет основных финансовых показателей
   путем суммирования аналогичных показателей для всех SKU, входящих в
   конкретную группу. Суммируются данные из таблицы [Чеки](../README.md#таблица-чеки).
   Подсчитываются следующие показатели:

    - Себестоимость купленного клиентом товара в течение
      анализируемого периода. Суммируются значения, полученные путем умножения данных из поля `SKU_Purchase_Price` на
      данные из поля `SKU_Amount`
      по всем SKU анализируемой группы для клиента. Данные
      сохраняются в поле `Group_Cost` таблицы [История покупок](../README.md#представление-история-покупок).

    - Базовая розничная стоимость в течение анализируемого периода.
      Суммируются данные из поля `SKU_Summ` по всем SKU
      анализируемой группы для клиента. Данные сохраняются в поле
      `Group_Summ` таблицы [История покупок](../README.md#представление-история-покупок).

    - Фактически оплаченная стоимость (с учетом оплаты покупок
      бонусами программы лояльности, но без учета скидок).
      Суммируются данные их поля `SKU_Summ_Paid` по всем SKU
      анализируемой группы для клиента. Данные сохраняются в поле
      `Group_Summ_Paid` таблицы [История покупок](../README.md#представление-история-покупок).

Расчет востребованности

6. **Определение общего количества транзакций клиента.** Определяется
   общее количество транзакций клиента, совершенных им между первой и
   последней транзакциями с анализируемой группой (включая транзакции,
   в рамках которых не было анализируемой группы), включая первую и
   последнюю транзакции с группой. Для этого подсчитывается количество
   уникальных значений в поле `Transaction_ID` таблицы [История покупок](../README.md#представление-история-покупок),
   дата совершения транзакций для которых больше или равна
   дате первой транзакции клиента с группой (значение поля
   `First_Group_Purchase_Date` таблицы [Периоды](../README.md#представление-периоды)) и меньше или
   равна дате последней транзакции клиента с группой (значение поля
   `Last_Group_Purchase_Date` таблицы [Периоды](../README.md#представление-периоды)).

7. **Расчет индекса востребованности группы.** Количество транзакций с
   анализируемой группой (значение поля `Group_Purchase` таблицы [Периоды](../README.md#представление-периоды)) делится
   на общее количество транзакций клиента,
   совершенных с первой по последнюю транзакции, в которых была
   анализируемая группа. Итоговое значение
   сохраняется для группы в поле `Group_Affinity_Index` таблицы Группы.

Расчет индекса оттока из группы

8. **Подсчет давности приобретения группы.**
   Из [даты формирования анализа](../README.md#таблица-дата-формирования-анализа) вычитается
   дата последней транзакции клиента, в которой была представлена
   анализируемая группа. Для определения последней даты покупки группы
   клиентом выбирается максимальное значение по полю `Transaction_DateTime`
   таблицы [История покупок](../README.md#представление-история-покупок) для записей, в которых значения полей
   `Customer_ID` и `Group_ID` соответствуют значениям аналогичных полей
   таблицы Группы.

9. **Расчет коэффициента оттока.** Количество дней, прошедших после
   даты последней транзакции клиента с анализируемой группой, делится на среднее количество дней между покупками
   анализируемой группы клиентом (значение поля `Group_Frequency`
   таблицы [Периоды](../README.md#представление-периоды)). Итоговое значение сохраняется в поле
   `Group_Churn_Rate` таблицы Группы.

Расчет стабильности потребления группы

10. **Расчет интервалов потребления группы.** Определяются все интервалы
    (в количестве дней) между транзакциями клиента, содержащими
    анализируемую группу. Для этого все транзакции, содержащие
    анализируемую группу в покупках клиента, ранжируются по дате
    совершения (значению поля `Transaction_DateTime`
    таблицы [История покупок](../README.md#представление-история-покупок)) от самой ранней к самой поздней. Из даты
    каждой
    последующей транзакции вычитается дата предыдущей. Каждый интервал
    учитывается отдельно.

11. **Подсчет абсолютного отклонения каждого интервала от средней
    частоты покупок группы.** Из значения каждого интервала вычитается
    среднее количество дней между транзакциями с анализируемой группой
    (значение поля `Group_Frequency` таблицы [Периоды](../README.md#представление-периоды)). В случае,
    если получившееся значение является отрицательным, оно умножается на
    -1.

12. **Подсчет относительного отклонения каждого интервала от средней
    частоты покупок группы.** Получившееся на предыдущем шаге значение для
    каждого интервала делится на среднее количество дней между
    транзакциями с анализируемой группой (значение поля
    `Group_Frequency` таблицы [Периоды](../README.md#представление-периоды)).

13. **Определение стабильности потребления группы.** Показатель
    стабильности потребления группы определяется как среднее значение
    всех показателей, получившихся на предыдущем шаге. Результат сохраняется в
    поле `Group_Stability_Index` таблицы Группы.

Расчет фактической маржи по группе для клиента

14. **Выбор метода расчета маржи.** По умолчанию маржа рассчитывается
    для всех транзакций в рамках анализируемого периода (используются
    все доступные данные). Но пользователь должен иметь возможность
    внести индивидуальные настройки и выбрать метод расчета актуальной
    маржи – по периоду или по количеству транзакций.

    - В случае выбора метода расчета маржи по периоду пользователь
      указывает, за какое количество дней от [даты формирования анализа](../README.md#таблица-дата-формирования-анализа)
      в обратном
      хронологическом порядке необходимо рассчитать маржу. Для
      расчета берутся все транзакции, в которых присутствует
      анализируемая группа, совершенные пользователем в указанный
      период. Для подсчетов используются данные, содержащиеся в поле
      `Transaction_DateTime` таблицы [История покупок](../README.md#представление-история-покупок).

    - В случае выбора метода расчета маржи по количеству транзакций
      пользователь указывает количество транзакций, для которых
      необходимо рассчитать маржу. Маржа считается по заданному
      количеству транзакций, начиная с последней, в обратном
      хронологическом порядке. Для подсчетов используются данные,
      содержащиеся в поле `Transaction_DateTime` таблицы История
      покупок`.

15. **Расчет фактической маржи по группе.** Для определения фактической
    маржи группы по клиенту в рамках анализируемого или заданного
    пользователем периода из суммы, на которую был куплен товар (поле
    `Group_Summ_Paid` таблицы [История покупок](../README.md#представление-история-покупок)) вычитается
    себестоимость приобретенного товара (значение поля `Group_Cost`
    таблицы [История покупок](../README.md#представление-история-покупок)). Итоговое значение сохраняется в качестве
    фактической маржи по данной группе для клиента в поле `Group_Margin`
    таблицы Группы.

Анализ предоставления скидок по группе

16. **Определение количества транзакций клиента со скидкой.**
    Определяется количество транзакций, в рамках которых анализируемая
    группа была приобретена клиентом с применением какой-либо скидки.
    Для подсчета используются уникальные значения по полю
    `Transaction_ID` таблицы [Чеки](../README.md#таблица-чеки) для транзакций, в рамках которых
    клиент приобретал анализируемую группу, при этом значение поля
    `SKU_Discount` таблицы [Чеки](../README.md#таблица-чеки) больше нуля. Скидка,
    представленная в рамках списания бонусных баллов, не учитывается.

17. **Определение доли транзакций со скидкой.** Количество транзакций, в
    рамках которых приобретение товаров из анализируемой группы было
    совершено со скидкой делится на общее
    количество транзакций клиента с анализируемой группой за
    анализируемый период (данные поля `Group_Purchase` таблицы [Периоды](../README.md#представление-периоды) для
    анализируемой группы по клиенту). Получившееся значения
    сохраняется в качестве доли транзакций по покупке анализируемой
    группы со скидкой в поле `Group_Discount_Share` таблицы Группы.

18. **Определение минимального размера скидки по группе.** Определяется
    минимальный размер скидки по каждой группе для каждого клиента. Для
    этого выбирается минимальное не равное нулю значение поля
    `Group_Min_Discount` таблицы [Периоды](../README.md#представление-периоды) для заданных клиента и
    группы. Результат сохраняется в поле `Group_Minimum_Discount`
    таблицы Группы.

19. **Определение среднего размера скидки по группе.** Для определения
    среднего размера скидки по группе для клиента фактически оплаченная
    сумма по покупке группы в рамках всех транзакций (значение поля
    `Group_Summ_Paid` таблицы [История покупок](../README.md#представление-история-покупок) для всех транзакций)
    делится на сумму розничной стоимости данной группы в рамках всех
    транзакций (сумма по группе по значению поля `Group_Paid` таблицы
    [История покупок](../README.md#представление-история-покупок)). Результат сохраняется в поле
    `Group_Average_Discount` таблицы Группы.
